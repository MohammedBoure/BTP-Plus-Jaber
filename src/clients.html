<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدير الأعمال - الزبائن</title>
    <link rel="manifest" href="/manifest.json">
    <script src="js/script.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="/libs/sql.js/sql-wasm.js"></script>
    <script src="/libs/lucide/lucide.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { primary: '#1E3A8A', success: '#10B981', warning: '#F59E0B', danger: '#EF4444' },
                    fontFamily: { 'inter': ['Inter', 'Noto Sans Arabic', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', 'Noto Sans Arabic', 'sans-serif'; }
        .transition-all { transition: all 0.3s ease; }
        .sidebar-expanded { width: 16rem; }
        .sidebar-collapsed { width: 4rem; }
        .sidebar-collapsed .nav-text, .sidebar-collapsed #logo-text { opacity: 0; visibility: hidden; transition: opacity 0.1s; }
        .main-content-expanded { margin-right: 16rem; }
        .main-content-collapsed { margin-right: 4rem; }
        [dir="ltr"] .main-content-expanded { margin-left: 16rem; margin-right: 0; }
        [dir="ltr"] .main-content-collapsed { margin-left: 4rem; margin-right: 0; }
        .nav-item.active { background-color: #1E3A8A; color: white; }
        .dark .nav-item.active { background-color: #1E3A8A; }
        .nav-item.active svg { color: white; }
        body { visibility: hidden; opacity: 0; transition: opacity 0.4s ease-in-out; }
        .modal { transition: opacity 0.3s ease, visibility 0.3s ease; }
        .filter-btn.active { background-color: #1E3A8A; color: white; border-color: #1E3A8A; }
        .dark .filter-btn.active { background-color: #3B82F6; border-color: #3B82F6;}
        
        .full-width-table-container {
            display: flex;
            flex-direction: column;
        }
        .full-width-table-container table {
            flex-grow: 1;
            width: 100%;
        }
    </style>
    <script src="js/loading_theme.js"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-950 text-gray-900 dark:text-gray-100 transition-colors duration-300">
    <!-- Sidebar -->
    <div id="sidebar" class="fixed right-0 top-0 h-full bg-white dark:bg-gray-800 shadow-lg transition-all sidebar-expanded z-30 border-l border-gray-200 dark:border-gray-700">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
            <div class="flex items-center space-x-3 overflow-hidden">
                <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center flex-shrink-0">
                    <span class="text-white font-bold text-sm">BM</span>
                </div>
                <span id="logo-text" class="font-bold text-lg text-gray-900 dark:text-white transition-opacity">مدير الأعمال</span>
            </div>
        </div>
        <nav class="mt-6">
            <a href="index.html" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <i data-lucide="layout-dashboard" class="w-5 h-5 flex-shrink-0"></i>
                <span class="nav-text mr-3 transition-opacity">لوحة التحكم</span>
            </a>
            <a href="products.html" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <i data-lucide="package" class="w-5 h-5 flex-shrink-0"></i>
                <span class="nav-text mr-3 transition-opacity">المنتجات</span>
            </a>
            <a href="clients.html" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <i data-lucide="users" class="w-5 h-5 flex-shrink-0"></i>
                <span class="nav-text mr-3 transition-opacity">الزبائن</span>
            </a>
            <a href="sales.html" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <i data-lucide="shopping-cart" class="w-5 h-5 flex-shrink-0"></i>
                <span class="nav-text mr-3 transition-opacity">المبيعات</span>
            </a>
            <a href="payments.html" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <i data-lucide="credit-card" class="w-5 h-5 flex-shrink-0"></i>
                <span class="nav-text mr-3 transition-opacity">المدفوعات</span>
            </a>
            <a href="settings.html" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                <i data-lucide="settings" class="w-5 h-5 flex-shrink-0"></i>
                <span class="nav-text mr-3 transition-opacity">الإعدادات</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="flex flex-col h-screen transition-all main-content-expanded">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700 p-4 flex items-center justify-between flex-shrink-0">
            <div class="flex items-center space-x-4">
                <button id="toggle-sidebar-btn" class="p-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <span id="toggle-icon"><i data-lucide="panel-left-close"></i></span>
                </button>
                <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">إدارة الزبائن</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="toggleTheme" class="p-2 rounded-lg text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                    <i data-lucide="moon" class="w-4 h-4"></i>
                </button>
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center">
                        <span class="text-white text-sm font-medium">A</span>
                    </div>
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">مستخدم إداري</span>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <main class="flex-1 p-6 overflow-auto">
            <div class="space-y-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">قائمة الزبائن</h2>
                    <a href="add-client.html" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors flex items-center gap-2">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        <span>إضافة عميل</span>
                    </a>
                </div>

                <!-- Filters -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="relative flex-grow">
                            <i data-lucide="search" class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                            <input type="text" id="clientSearch" placeholder="ابحث عن الزبائن بالاسم أو الهاتف..." class="w-full p-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                        </div>
                        <div id="clientFilters" class="flex items-center gap-2 flex-shrink-0">
                            <button data-filter="all" class="filter-btn active px-4 py-2 text-sm font-medium border rounded-lg transition-colors flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i>كل الزبائن</button>
                            <button data-filter="debt" class="filter-btn px-4 py-2 text-sm font-medium border rounded-lg transition-colors flex items-center gap-2"><i data-lucide="circle-dollar-sign" class="w-4 h-4"></i>عليهم ديون</button>
                        </div>
                    </div>
                </div>

                <!-- Clients Table -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 overflow-x-auto full-width-table-container">
                    <table class="w-full text-sm text-gray-600 dark:text-gray-400">
                        <thead class="text-sm text-gray-700 dark:text-gray-300 uppercase bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th class="p-3 text-right">اسم العميل</th>
                                <th class="p-3 text-right">رقم الهاتف</th>
                                <th class="p-3 text-right">عميل منتظم</th>
                                <th class="p-3 text-right">الكريدي</th>
                                <th class="p-3 text-center">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="clientsTableBody" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Debts Modal -->
    <div id="debtsModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 invisible opacity-0 modal z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-4xl max-h-[90vh] flex flex-col">
            <header class="flex justify-between items-center p-4 border-b dark:border-gray-700 flex-shrink-0">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white" id="debtsModalTitle">ديون العميل</h2>
                <button id="closeDebtsModal" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </header>
            <main id="debtsModalBody" class="p-6 overflow-y-auto"></main>
            <footer id="debtsModalFooter" class="p-4 border-t dark:border-gray-700 flex-shrink-0 flex justify-end"></footer>
        </div>
    </div>
    
    <!-- Sale Details Modal (Nested) -->
    <div id="saleDetailsModal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 invisible opacity-0 modal z-[60]">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-2xl max-h-[85vh] flex flex-col">
            <header class="flex justify-between items-center p-4 border-b dark:border-gray-700 flex-shrink-0">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white" id="saleDetailsModalTitle">تفاصيل الفاتورة</h2>
                <button id="closeSaleDetailsModal" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </header>
            <main id="saleDetailsModalBody" class="p-6 overflow-y-auto"></main>
        </div>
    </div>

    <!-- Add Payment Modal -->
    <div id="addPaymentModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 invisible opacity-0 modal z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-md flex flex-col">
            <header class="flex justify-between items-center p-4 border-b dark:border-gray-700 flex-shrink-0">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white" id="addPaymentModalTitle">إضافة دفعة</h2>
                <button id="closeAddPaymentModal" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </header>
            <main class="p-6 space-y-4">
                <div>
                    <label for="paymentAmount" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">المبلغ المدفوع</label>
                    <input type="number" id="paymentAmount" name="paymentAmount" placeholder="أدخل المبلغ..." class="w-full p-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:ring-primary focus:border-primary" required>
                    <p id="maxAmountInfo" class="text-xs text-gray-500 mt-1"></p>
                </div>
                 <div>
                    <label for="paymentNotes" class="block mb-2 text-sm font-medium text-gray-700 dark:text-gray-300">ملاحظات (اختياري)</label>
                    <textarea id="paymentNotes" name="paymentNotes" rows="3" placeholder="أضف ملاحظاتك هنا..." class="w-full p-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 focus:ring-primary focus:border-primary"></textarea>
                </div>
            </main>
            <footer class="p-4 border-t dark:border-gray-700 flex-shrink-0 flex justify-end">
                <button id="savePaymentBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 flex items-center gap-2">
                    <i data-lucide="save" class="w-4 h-4"></i> حفظ الدفعة
                </button>
            </footer>
        </div>
    </div>

    <!-- Global JS (Theme, Sidebar, etc.) -->
    <script>
        let sidebarCollapsed = false;
        function toggleSidebar() {
            const t = document.getElementById("sidebar"), e = document.getElementById("main-content"), i = document.getElementById("toggle-icon");
            (sidebarCollapsed = !sidebarCollapsed) ?
                (t.classList.remove("sidebar-expanded"), t.classList.add("sidebar-collapsed"), e.classList.remove("main-content-expanded"), e.classList.add("main-content-collapsed"), i && (i.innerHTML = '<i data-lucide="panel-left-open"></i>')) :
                (t.classList.remove("sidebar-collapsed"), t.classList.add("sidebar-expanded"), e.classList.remove("main-content-collapsed"), e.classList.add("main-content-expanded"), i && (i.innerHTML = '<i data-lucide="panel-left-close"></i>'));
            lucide.createIcons();
        }
        function handleResize() { if (window.innerWidth < 768 && !sidebarCollapsed) toggleSidebar(); }
        document.addEventListener("DOMContentLoaded", () => {
            document.documentElement.lang = "ar"; document.documentElement.dir = "rtl";
            let savedTheme = localStorage.getItem("theme") || "light";
            if (savedTheme === "dark") document.documentElement.classList.add("dark");
            document.getElementById("toggleTheme").innerHTML = savedTheme === 'dark' ? '<i data-lucide="sun" class="w-4 h-4"></i>' : '<i data-lucide="moon" class="w-4 h-4"></i>';
            document.getElementById("toggle-sidebar-btn").addEventListener("click", toggleSidebar);
            const currentPage = "clients.html";
            document.querySelectorAll(".nav-item").forEach(link => {
                if (link.getAttribute("href") === currentPage) link.classList.add("active");
            });
            document.body.style.visibility = "visible"; document.body.style.opacity = "1";
            lucide.createIcons();
        });
        document.getElementById("toggleTheme").addEventListener("click", () => {
            const isDark = document.documentElement.classList.toggle("dark");
            const newTheme = isDark ? "dark" : "light";
            localStorage.setItem("theme", newTheme);
            document.getElementById("toggleTheme").innerHTML = isDark ? '<i data-lucide="sun" class="w-4 h-4"></i>' : '<i data-lucide="moon" class="w-4 h-4"></i>';
            lucide.createIcons();
        });
        window.addEventListener("resize", handleResize);
    </script>
    <script type="module" src="js/clients.js"></script>
</body>
</html>